---
phase: 01-infrastructure-image-gallery
plan: 04
type: execute
wave: 3
depends_on:
  - 01-03
files_modified:
  - internal/handlers/media_handler.go
  - cmd/api/main.go
autonomous: true
requirements:
  - IMG-ADM-03
  - IMG-ADM-04
  - IMG-ADM-05
must_haves:
  truths:
    - "Admin can delete images via DELETE /admin/images/:id"
    - "Admin can change visibility via PUT /admin/images/:id/visibility"
    - "Admin can edit metadata via PUT /admin/images/:id"
    - "Deleting image removes both S3 object and DB records"
  artifacts:
    - path: "internal/handlers/media_handler.go"
      provides: "Admin image management handlers"
      exports: ["DeleteImage", "UpdateImageVisibility", "UpdateImageMetadata"]
    - path: "cmd/api/main.go"
      provides: "Route registration"
      contains: "DELETE.*images"
  key_links:
    - from: "internal/handlers/media_handler.go"
      to: "internal/services/media_service.go"
      via: "method calls"
      pattern: "mediaService\\.(Delete|Update)"
---

<objective>
Create admin endpoints for image deletion, visibility management, and metadata editing.

Purpose: Complete the admin image management functionality. Admins need to be able to delete images (with proper S3 cleanup), change visibility between private/public, and edit title/description metadata.

Output: Extended MediaHandler with DeleteImage, UpdateImageVisibility, UpdateImageMetadata endpoints
</objective>

<execution_context>
@/home/munnotubbel/.claude/get-shit-done/workflows/execute-plan.md
@/home/munnotubbel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/munnotubbel/github/synesthesie-backend/.planning/PROJECT.md
@/home/munnotubbel/github/synesthesie-backend/.planning/ROADMAP.md
@/home/munnotubbel/github/synesthesie-backend/.planning/REQUIREMENTS.md
@/home/munnotubbel/github/synesthesie-backend/internal/handlers/media_handler.go
@/home/munnotubbel/github/synesthesie-backend/cmd/api/main.go
@/home/munnotubbel/github/synesthesie-backend/internal/services/media_service.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add image management endpoints to MediaHandler</name>
  <files>internal/handlers/media_handler.go</files>
  <action>
Add the following methods to MediaHandler in internal/handlers/media_handler.go:

```go
// DeleteImage handles image deletion (IMG-ADM-03)
// DELETE /admin/images/:id
// Deletes S3 object first, then DB records (SEC-04)
func (h *MediaHandler) DeleteImage(c *gin.Context) {
    imageIDStr := c.Param("id")
    imageID, err := uuid.Parse(imageIDStr)
    if err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": "invalid image ID"})
        return
    }

    if err := h.mediaService.DeleteImage(c.Request.Context(), imageID); err != nil {
        if strings.Contains(err.Error(), "not found") {
            c.JSON(http.StatusNotFound, gin.H{"error": "image not found"})
            return
        }
        c.JSON(http.StatusInternalServerError, gin.H{"error": "failed to delete image"})
        return
    }

    c.JSON(http.StatusOK, gin.H{
        "message": "image deleted successfully",
        "id":      imageID,
    })
}

// UpdateImageVisibility changes visibility between private/public (IMG-ADM-04)
// PUT /admin/images/:id/visibility
// Body: {"visibility": "public"} or {"visibility": "private"}
func (h *MediaHandler) UpdateImageVisibility(c *gin.Context) {
    imageIDStr := c.Param("id")
    imageID, err := uuid.Parse(imageIDStr)
    if err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": "invalid image ID"})
        return
    }

    var req struct {
        Visibility string `json:"visibility" binding:"required"`
    }
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": "visibility is required"})
        return
    }

    if req.Visibility != "private" && req.Visibility != "public" {
        c.JSON(http.StatusBadRequest, gin.H{"error": "visibility must be 'private' or 'public'"})
        return
    }

    if err := h.mediaService.UpdateImageVisibility(imageID, req.Visibility); err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": "failed to update visibility"})
        return
    }

    c.JSON(http.StatusOK, gin.H{
        "message":    "visibility updated successfully",
        "id":         imageID,
        "visibility": req.Visibility,
    })
}

// UpdateImageMetadata updates title and description (IMG-ADM-05)
// PUT /admin/images/:id
// Body: {"title": "...", "description": "..."} (both optional)
func (h *MediaHandler) UpdateImageMetadata(c *gin.Context) {
    imageIDStr := c.Param("id")
    imageID, err := uuid.Parse(imageIDStr)
    if err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": "invalid image ID"})
        return
    }

    var req struct {
        Title       *string `json:"title"`
        Description *string `json:"description"`
    }
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
        return
    }

    // Build update values
    title := ""
    description := ""
    if req.Title != nil {
        title = *req.Title
    }
    if req.Description != nil {
        description = *req.Description
    }

    if err := h.mediaService.UpdateImageMetadata(imageID, title, description); err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": "failed to update metadata"})
        return
    }

    // Return updated image
    image, err := h.mediaService.GetImageByID(imageID)
    if err != nil {
        c.JSON(http.StatusOK, gin.H{
            "message": "metadata updated successfully",
            "id":      imageID,
        })
        return
    }

    c.JSON(http.StatusOK, gin.H{
        "message":     "metadata updated successfully",
        "id":          image.ID,
        "title":       image.Title,
        "description": image.Description,
    })
}
```

Ensure "strings" is imported for the DeleteImage error check.
</action>
  <verify>
go build ./... 2>&1 | head -20
</verify>
  <done>
MediaHandler has DeleteImage, UpdateImageVisibility, UpdateImageMetadata methods
</done>
</task>

<task type="auto">
  <name>Task 2: Register new routes in main.go</name>
  <files>cmd/api/main.go</files>
  <action>
Add the new routes to the admin routes group in cmd/api/main.go.

Find the image gallery routes section (added in Plan 03) and extend it:

```go
// Image gallery management
admin.POST("/images", mediaHandler.UploadImage)
admin.POST("/images/batch", mediaHandler.UploadImages)
admin.GET("/images", mediaHandler.GetAllImages)
admin.GET("/images/:id", mediaHandler.GetImageDetails)
admin.DELETE("/images/:id", mediaHandler.DeleteImage)                        // NEW: IMG-ADM-03
admin.PUT("/images/:id/visibility", mediaHandler.UpdateImageVisibility)      // NEW: IMG-ADM-04
admin.PUT("/images/:id", mediaHandler.UpdateImageMetadata)                   // NEW: IMG-ADM-05
```

Note: PUT /images/:id/visibility must be registered before PUT /images/:id to avoid route conflicts (specific routes before generic :id routes - same pattern as existing event routes).
</action>
  <verify>
grep -E "DELETE.*images|visibility|UpdateImageMetadata" cmd/api/main.go && go build ./...
</verify>
  <done>
main.go has DELETE, PUT visibility, PUT metadata routes for /admin/images
</done>
</task>

</tasks>

<verification>
1. Run `go build ./...` - must succeed
2. Verify MediaHandler has DeleteImage, UpdateImageVisibility, UpdateImageMetadata
3. Verify routes: DELETE /admin/images/:id, PUT /admin/images/:id/visibility, PUT /admin/images/:id
4. Verify visibility route is registered before generic :id route
</verification>

<success_criteria>
- Admin can delete images with S3 + DB cleanup (IMG-ADM-03)
- Admin can change visibility to private/public (IMG-ADM-04)
- Admin can edit title and description (IMG-ADM-05)
- All routes registered with proper ordering
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-image-gallery/01-04-SUMMARY.md`
</output>
