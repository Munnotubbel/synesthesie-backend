---
phase: 01-infrastructure-image-gallery
plan: 05
type: execute
wave: 3
depends_on:
  - 01-01
  - 01-02
files_modified:
  - internal/handlers/media_handler.go
  - cmd/api/main.go
autonomous: true
requirements:
  - IMG-USR-01
  - IMG-USR-02
  - IMG-USR-03
must_haves:
  truths:
    - "User can list all public images via GET /user/images"
    - "User can get single image with presigned URL via GET /user/images/:id"
    - "Presigned URLs have 15-minute TTL for fast loading"
    - "Private images are not accessible to users"
  artifacts:
    - path: "internal/handlers/media_handler.go"
      provides: "User image viewing handlers"
      exports: ["GetPublicImages", "GetPublicImage"]
    - path: "cmd/api/main.go"
      provides: "Route registration"
      contains: "/user/images"
  key_links:
    - from: "internal/handlers/media_handler.go"
      to: "internal/services/media_service.go"
      via: "method calls"
      pattern: "GetPublicImages|GetPresignedImageURL"
---

<objective>
Create user endpoints for viewing public images with presigned URLs.

Purpose: Enable authenticated users to browse and view images that have been made public by admins. Images are delivered via presigned URLs for secure, fast loading while keeping the S3 bucket private.

Output: Extended MediaHandler with user-facing GetPublicImages and GetPublicImage endpoints
</objective>

<execution_context>
@/home/munnotubbel/.claude/get-shit-done/workflows/execute-plan.md
@/home/munnotubbel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/munnotubbel/github/synesthesie-backend/.planning/PROJECT.md
@/home/munnotubbel/github/synesthesie-backend/.planning/ROADMAP.md
@/home/munnotubbel/github/synesthesie-backend/.planning/REQUIREMENTS.md
@/home/munnotubbel/github/synesthesie-backend/internal/handlers/media_handler.go
@/home/munnotubbel/github/synesthesie-backend/internal/handlers/user_handler.go
@/home/munnotubbel/github/synesthesie-backend/cmd/api/main.go
@/home/munnotubbel/github/synesthesie-backend/internal/services/media_service.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user image viewing endpoints to MediaHandler</name>
  <files>internal/handlers/media_handler.go</files>
  <action>
Add the following methods to MediaHandler in internal/handlers/media_handler.go for user-facing functionality:

```go
// GetPublicImages lists all public images for users (IMG-USR-01)
// GET /user/images?page=1&limit=20
// Only returns images with visibility='public'
func (h *MediaHandler) GetPublicImages(c *gin.Context) {
    page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
    limit, _ := strconv.Atoi(c.DefaultQuery("limit", "20"))
    if limit > 50 {
        limit = 50
    }
    offset := (page - 1) * limit

    images, total, err := h.mediaService.GetPublicImages(limit, offset)
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": "failed to retrieve images"})
        return
    }

    // Build response with presigned URLs for fast loading (IMG-USR-03)
    imageList := make([]gin.H, len(images))
    for i, img := range images {
        presignedURL, err := h.mediaService.GetPresignedImageURL(c.Request.Context(), img.Asset.Key)
        if err != nil {
            presignedURL = "" // Continue without URL if presign fails
        }

        imageList[i] = gin.H{
            "id":            img.ID,
            "title":         img.Title,
            "description":   img.Description,
            "presigned_url": presignedURL,
            "created_at":    img.CreatedAt,
        }
    }

    c.JSON(http.StatusOK, gin.H{
        "images": imageList,
        "pagination": gin.H{
            "page":  page,
            "limit": limit,
            "total": total,
        },
    })
}

// GetPublicImage gets a single public image with presigned URL (IMG-USR-02)
// GET /user/images/:id
// Returns 404 if image is not public
func (h *MediaHandler) GetPublicImage(c *gin.Context) {
    imageIDStr := c.Param("id")
    imageID, err := uuid.Parse(imageIDStr)
    if err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": "invalid image ID"})
        return
    }

    image, err := h.mediaService.GetImageByID(imageID)
    if err != nil {
        c.JSON(http.StatusNotFound, gin.H{"error": "image not found"})
        return
    }

    // Enforce visibility: only public images accessible to users
    if image.Visibility != "public" {
        c.JSON(http.StatusNotFound, gin.H{"error": "image not found"})
        return
    }

    // Generate presigned URL with short TTL (SEC-01)
    presignedURL, err := h.mediaService.GetPresignedImageURL(c.Request.Context(), image.Asset.Key)
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": "failed to generate image URL"})
        return
    }

    // Set cache headers for fast loading (IMG-USR-03)
    // Browser can cache for 14 minutes (slightly less than URL TTL)
    c.Header("Cache-Control", "private, max-age=840")

    c.JSON(http.StatusOK, gin.H{
        "id":            image.ID,
        "title":         image.Title,
        "description":   image.Description,
        "presigned_url": presignedURL,
        "mime_type":     image.Asset.MimeType,
        "size_bytes":    image.Asset.SizeBytes,
        "created_at":    image.CreatedAt,
    })
}
```

Key design decisions:
- Only public images visible to users (visibility check in GetPublicImage)
- Presigned URLs generated per-request with 15-min TTL
- Cache-Control header set to slightly less than TTL
- Pagination for list endpoint
</action>
  <verify>
go build ./... 2>&1 | head -20
</verify>
  <done>
MediaHandler has GetPublicImages and GetPublicImage methods for user access
</done>
</task>

<task type="auto">
  <name>Task 2: Register user image routes in main.go</name>
  <files>cmd/api/main.go</files>
  <action>
Add user image routes to the user routes group in cmd/api/main.go.

Find the user routes section (around line 231-247) and add image routes:

```go
// User routes
user := api.Group("/user")
user.Use(middleware.Auth(authService))
{
    // ... existing user routes ...

    // Image gallery (user viewing)
    user.GET("/images", mediaHandler.GetPublicImages)       // List public images
    user.GET("/images/:id", mediaHandler.GetPublicImage)     // Get single public image
}
```

The routes are protected by Auth middleware (requires valid JWT token).
</action>
  <verify>
grep -E "user.GET.*images|mediaHandler.GetPublic" cmd/api/main.go && go build ./...
</verify>
  <done>
main.go has GET /user/images and GET /user/images/:id routes
</done>
</task>

</tasks>

<verification>
1. Run `go build ./...` - must succeed
2. Verify MediaHandler has GetPublicImages and GetPublicImage methods
3. Verify user routes registered under /api/v1/user/images
4. Verify visibility check in GetPublicImage (returns 404 for private images)
5. Verify Cache-Control header is set for fast loading
</verification>

<success_criteria>
- Users can list all public images with pagination (IMG-USR-01)
- Users can get single image with presigned URL (IMG-USR-02)
- Presigned URLs generated with 15-minute TTL (SEC-01)
- Cache-Control headers for fast browser loading (IMG-USR-03)
- Private images return 404 to users (visibility enforcement)
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-image-gallery/01-05-SUMMARY.md`
</output>
