---
phase: 01-infrastructure-image-gallery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/models/image.go
  - internal/models/db.go
autonomous: true
requirements:
  - INFRA-02
  - INFRA-03
must_haves:
  truths:
    - "Image model exists in the codebase with all required fields"
    - "GORM AutoMigrate includes the Image model"
    - "Database migration runs successfully on startup"
  artifacts:
    - path: "internal/models/image.go"
      provides: "Image model definition"
      min_lines: 30
      contains: "type Image struct"
    - path: "internal/models/db.go"
      provides: "Migration registration"
      contains: "&Image{}"
  key_links:
    - from: "internal/models/db.go"
      to: "internal/models/image.go"
      via: "import and AutoMigrate"
      pattern: "AutoMigrate.*&Image"
---

<objective>
Create the Image database model and register it with GORM AutoMigrate.

Purpose: Establish the data foundation for the image gallery feature. The Image model stores metadata about uploaded images and references the existing Asset model for storage information.

Output: New Image model in internal/models/image.go, updated AutoMigrate in db.go
</objective>

<execution_context>
@/home/munnotubbel/.claude/get-shit-done/workflows/execute-plan.md
@/home/munnotubbel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/munnotubbel/github/synesthesie-backend/.planning/PROJECT.md
@/home/munnotubbel/github/synesthesie-backend/.planning/ROADMAP.md
@/home/munnotubbel/github/synesthesie-backend/.planning/REQUIREMENTS.md
@/home/munnotubbel/github/synesthesie-backend/internal/models/asset.go
@/home/munnotubbel/github/synesthesie-backend/internal/models/db.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Image model</name>
  <files>internal/models/image.go</files>
  <action>
Create a new file internal/models/image.go with the Image model:

```go
package models

import (
    "time"

    "github.com/google/uuid"
    "gorm.io/gorm"
)

// Image represents an image in the gallery with metadata
// References the existing Asset model for S3 storage information
type Image struct {
    ID          uuid.UUID `gorm:"type:uuid;primaryKey" json:"id"`
    AssetID     uuid.UUID `gorm:"type:uuid;not null" json:"asset_id"`
    Title       string    `gorm:"size:255" json:"title"`
    Description string    `gorm:"size:1000" json:"description"`
    Visibility  string    `gorm:"size:16;default:'private'" json:"visibility"` // private|public

    CreatedAt time.Time `json:"created_at"`
    UpdatedAt time.Time `json:"updated_at"`

    // Relation to Asset (existing model)
    Asset *Asset `gorm:"foreignKey:AssetID" json:"asset,omitempty"`
}

func (i *Image) BeforeCreate(tx *gorm.DB) error {
    if i.ID == uuid.Nil {
        i.ID = uuid.New()
    }
    return nil
}
```

Key design decisions:
- UUID primary key (consistent with existing models)
- Foreign key to existing Asset model for S3 storage info
- Visibility field for admin-controlled public/private status
- Title and Description for metadata editing (IMG-ADM-05)
- No owner_id - images are system-managed, not user-owned
</action>
  <verify>
go build ./... 2>&1 | head -20
</verify>
  <done>
File internal/models/image.go exists with Image struct containing ID, AssetID, Title, Description, Visibility, CreatedAt, UpdatedAt fields and BeforeCreate hook
</done>
</task>

<task type="auto">
  <name>Task 2: Register Image model in AutoMigrate</name>
  <files>internal/models/db.go</files>
  <action>
Update the Migrate function in internal/models/db.go to include the Image model in AutoMigrate:

Find the db.AutoMigrate(...) call and add &Image{} to the list of models:

```go
return db.AutoMigrate(
    &User{},
    &Event{},
    &Ticket{},
    &InviteCode{},
    &RefreshToken{},
    &SystemSetting{},
    &Asset{},
    &PhoneVerification{},
    &PasswordReset{},
    &Backup{},
    &Image{}, // NEW: Image gallery model
)
```

This ensures the images table is created on next startup via GORM AutoMigrate.
</action>
  <verify>
grep -n "&Image{}" internal/models/db.go && go build ./...
</verify>
  <done>
db.go contains &Image{} in AutoMigrate call, go build succeeds
</done>
</task>

</tasks>

<verification>
1. Run `go build ./...` - must succeed without errors
2. Verify Image model has all required fields: ID, AssetID, Title, Description, Visibility
3. Verify Image model has BeforeCreate hook for UUID generation
4. Verify db.go AutoMigrate includes &Image{}
</verification>

<success_criteria>
- Image model created with UUID primary key
- Foreign key to Asset model for storage reference
- Visibility field (private/public) for access control
- AutoMigrate updated to include Image model
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-image-gallery/01-01-SUMMARY.md`
</output>
