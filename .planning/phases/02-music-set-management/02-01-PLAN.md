---
phase: 02-music-set-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/models/music_set.go
  - internal/models/db.go
autonomous: true
requirements:
  - MSC-ADM-01
  - MSC-ADM-02
must_haves:
  truths:
    - "MusicSet model exists with title, description, and visibility fields"
    - "MusicTrack model exists with title, artist, asset relation, and ordering"
    - "GORM AutoMigrate includes both new models"
    - "Database migration runs successfully on startup"
  artifacts:
    - path: "internal/models/music_set.go"
      provides: "MusicSet and MusicTrack model definitions"
      min_lines: 60
      contains: "type MusicSet struct"
    - path: "internal/models/db.go"
      provides: "Migration registration"
      contains: "&MusicSet{}"
  key_links:
    - from: "internal/models/db.go"
      to: "internal/models/music_set.go"
      via: "import and AutoMigrate"
      pattern: "AutoMigrate.*&MusicSet"
    - from: "MusicTrack"
      to: "MusicSet"
      via: "foreign key MusicSetID"
      pattern: "MusicSetID.*uuid"
---

<objective>
Create the MusicSet and MusicTrack database models and register them with GORM AutoMigrate.

Purpose: Establish the data foundation for music set management. MusicSet represents a collection of tracks (like an album or DJ set). MusicTrack represents individual audio files within a set. Tracks reference the existing Asset model for S3 storage information.

Output: New models in internal/models/music_set.go, updated AutoMigrate in db.go
</objective>

<execution_context>
@/home/munnotubbel/.claude/get-shit-done/workflows/execute-plan.md
@/home/munnotubbel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/munnotubbel/github/synesthesie-backend/.planning/PROJECT.md
@/home/munnotubbel/github/synesthesie-backend/.planning/ROADMAP.md
@/home/munnotubbel/github/synesthesie-backend/.planning/REQUIREMENTS.md
@/home/munnotubbel/github/synesthesie-backend/internal/models/image.go
@/home/munnotubbel/github/synesthesie-backend/internal/models/asset.go
@/home/munnotubbel/github/synesthesie-backend/internal/models/db.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MusicSet and MusicTrack models</name>
  <files>internal/models/music_set.go</files>
  <action>
Create a new file internal/models/music_set.go with MusicSet and MusicTrack models:

```go
package models

import (
	"time"

	"github.com/google/uuid"
	"gorm.io/gorm"
)

// MusicSet represents a collection of music tracks (album, DJ set, etc.)
type MusicSet struct {
	ID          uuid.UUID `gorm:"type:uuid;primaryKey" json:"id"`
	Title       string    `gorm:"size:255;not null" json:"title"`
	Description string    `gorm:"size:2000" json:"description"`
	Visibility  string    `gorm:"size:16;default:'private'" json:"visibility"` // private|public

	CreatedAt time.Time `json:"created_at"`
	UpdatedAt time.Time `json:"updated_at"`

	// Relation to tracks (has-many)
	Tracks []MusicTrack `gorm:"foreignKey:MusicSetID;constraint:OnDelete:CASCADE" json:"tracks,omitempty"`
}

// BeforeCreate generates a UUID if not set
func (m *MusicSet) BeforeCreate(tx *gorm.DB) error {
	if m.ID == uuid.Nil {
		m.ID = uuid.New()
	}
	return nil
}

// MusicTrack represents an individual audio track within a MusicSet
type MusicTrack struct {
	ID         uuid.UUID `gorm:"type:uuid;primaryKey" json:"id"`
	MusicSetID uuid.UUID `gorm:"type:uuid;not null;index" json:"music_set_id"`
	AssetID    uuid.UUID `gorm:"type:uuid;not null" json:"asset_id"`
	Title      string    `gorm:"size:255" json:"title"`
	Artist     string    `gorm:"size:255" json:"artist"`
	TrackOrder int       `gorm:"default:0" json:"track_order"` // Order within the set
	Duration   int       `gorm:"default:0" json:"duration"`    // Duration in seconds (optional)

	CreatedAt time.Time `json:"created_at"`
	UpdatedAt time.Time `json:"updated_at"`

	// Relations
	MusicSet *MusicSet `gorm:"foreignKey:MusicSetID" json:"music_set,omitempty"`
	Asset    *Asset    `gorm:"foreignKey:AssetID" json:"asset,omitempty"`
}

// BeforeCreate generates a UUID if not set
func (t *MusicTrack) BeforeCreate(tx *gorm.DB) error {
	if t.ID == uuid.Nil {
		t.ID = uuid.New()
	}
	return nil
}
```

Key design decisions (following Image model pattern):
- UUID primary keys (consistent with existing models)
- MusicSet has title, description, visibility (mirrors Image pattern)
- MusicTrack belongs to MusicSet via MusicSetID with CASCADE delete
- MusicTrack references Asset for S3 storage info (mirrors Image -> Asset pattern)
- TrackOrder for ordering tracks within a set
- Duration field for optional track length (populated from audio metadata if available)
</action>
  <verify>
go build ./... 2>&1 | head -20
</verify>
  <done>
File internal/models/music_set.go exists with MusicSet and MusicTrack structs containing all required fields and BeforeCreate hooks
</done>
</task>

<task type="auto">
  <name>Task 2: Register MusicSet and MusicTrack models in AutoMigrate</name>
  <files>internal/models/db.go</files>
  <action>
Update the Migrate function in internal/models/db.go to include the new models in AutoMigrate:

Find the db.AutoMigrate(...) call and add &MusicSet{} and &MusicTrack{} to the list:

```go
return db.AutoMigrate(
	&User{},
	&Event{},
	&Ticket{},
	&InviteCode{},
	&RefreshToken{},
	&SystemSetting{},
	&Asset{},
	&PhoneVerification{},
	&PasswordReset{},
	&Backup{},
	&Image{},      // Image gallery model
	&MusicSet{},   // Music set model
	&MusicTrack{}, // Music track model
)
```

This ensures the music_sets and music_tracks tables are created on next startup via GORM AutoMigrate.
</action>
  <verify>
grep -n "&MusicSet{}\|&MusicTrack{}" internal/models/db.go && go build ./...
</verify>
  <done>
db.go contains &MusicSet{} and &MusicTrack{} in AutoMigrate call, go build succeeds
</done>
</task>

</tasks>

<verification>
1. Run `go build ./...` - must succeed without errors
2. Verify MusicSet model has: ID, Title, Description, Visibility, Tracks relation
3. Verify MusicTrack model has: ID, MusicSetID, AssetID, Title, Artist, TrackOrder, Duration
4. Verify both models have BeforeCreate hooks for UUID generation
5. Verify db.go AutoMigrate includes &MusicSet{} and &MusicTrack{}
</verification>

<success_criteria>
- MusicSet model created with UUID primary key, title, description, visibility
- MusicTrack model created with relations to MusicSet and Asset
- Track ordering support via TrackOrder field
- CASCADE delete configured (deleting set deletes all tracks)
- AutoMigrate updated to include both models
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-music-set-management/02-01-SUMMARY.md`
</output>
